# 演講網 ZIP 上傳安全性防護說明文件

本文件摘要說明了針對演講網 (Speech Portal) **FR-010**「ZIP 上傳與解壓縮功能」所實作的安全防護機制。

---

## 🛡️ 安全防護四大防線

為了確保伺服器免受惡意上傳攻擊，我們實作了從「檔案層」到「伺服器環境層」的多重防護。

### 1. 防路徑穿越 (Anti-Zip Slip)
*   **做法**：程式碼在解壓前會檢視 ZIP 內每一個檔案的名稱，判斷是否含有 `..`、`/` 或 `\` 等路徑控制字元。
*   **技術說明**：手動過濾無效與危險路徑，不依賴系統自動解壓。
*   **效果**：駭客無法透過惡意路徑將檔案寫入 `uploads` 目錄以外的地方（例如無法覆蓋 `index.php` 或 `config.php`）。

### 2. 檔案格式白名單 (Extension Whitelisting)
*   **做法**：嚴格限制解壓後的檔案副檔名。目前只允許：`html`, `htm`, `css`, `js`, `jpg`, `jpeg`, `png`, `gif`, `svg`, `webp`, `mp4`, `json`。
*   **效果**：所有可執行檔案（如 `.php`, `.exe`, `.bat`）都會在解壓過程中被**自動丟棄**，避免伺服器被植入後門。

### 3. 目錄執行封鎖 (.htaccess Execution Layer)
*   **做法**：在 `uploads/` 存放目錄下動態部署 `.htaccess` 安全設定檔。
*   **技術說明**：
    *   強制關閉 PHP 解析引擎 (`php_flag engine off`)。
    *   拒絕任何腳本副檔名的存取請求。
*   **效果**：這是一份「保險」。萬一未來程式碼有漏洞讓 PHP 檔案溜得進去，當駭客嘗試執行該檔案網址時，伺服器會直接回應「403 Forbidden」或只當作普通文字顯示，**惡意腳本絕對跑不起來**。

### 4. 預防容量炸彈 (Decompression Bomb Protection)
*   **做法**：程式會在進入解壓縮流程前，預先掃描 ZIP 檔頭內宣告的「原始大小」。
*   **限制**：**512MB** (可視需求調整)。
*   **效果**：如果偵測到解壓後容量超標，系統會直接拒絕處理，防止伺服器硬碟空間被惡意塞滿而造成當機 (DoS)。

---

## 📊 攻擊防禦對照表

| 攻擊類型 | 風鏡描述 | 防護狀態 | 實作位置 |
| :--- | :--- | :---: | :--- |
| **Zip Slip** | 駭客嘗試覆蓋系統核心檔案 | **✅ 已封鎖** | `upload.php` |
| **WebShell** | 駭客上傳 PHP 後門獲取權限 | **✅ 已封鎖** | `upload.php` & `.htaccess` |
| **XSS** | HTML 內藏惡意 JS 偷取帳號 | **✅ 已封鎖** | `watch.php` (Iframe Sandbox) |
| **DoS** | 上傳巨型檔案塞爆硬碟 | **✅ 已封鎖** | `upload.php` (512MB 限制) |

## 🛠️ 維護建議
*   **定期清理**：雖然已有安全過濾，但建議管理員定期巡檢 `uploads/videos/` 目錄。
*   **白名單擴充**：若未來有新的靜態資源需求（如 `.pdf`），需手動將其加入 `upload.php` 的 `$allowed_inner_exts` 陣列中。

---
*文件產生日期：2025-12-23*
