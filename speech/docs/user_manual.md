# 學術演講影片平台 - 使用者手冊（第一部分）

## 📚 系統概述

**學術演講影片平台** 是一個專為學術機構設計的影片管理與分享系統，支援多院區管理、EverCam 錄影檔案整合、自動轉檔、公告管理等完整功能。

### 🎯 核心功能
- ✅ 影片上傳與管理（支援 MP4 和 EverCam ZIP）
- ✅ 自動轉檔排程系統
- ✅ 多院區分類管理
- ✅ 公告管理（含輪播功能和自動過期）
- ✅ 觀看進度追蹤
- ✅ 搜尋與篩選
- ✅ 使用現有帳號登入（整合院內帳號系統）

---

## 👥 使用者角色與權限

系統分為**四種角色**，擁有不同的權限：

### 0️⃣ 訪客（未登入使用者）
**可以做的事情**：
- 瀏覽首頁和完成轉檔的影片列表
- 使用搜尋和院區篩選功能
- 查看公告資訊
- 點擊影片查看詳細資訊

**無法做的事情**：
- ❌ 觀看影片（必須登入）
- ❌ 記錄觀看進度
- ❌ 上傳或管理任何內容
- ❌ 訪問管理功能

**提示**：點擊影片時會跳出登入視窗，登入後即可觀看。

### 1️⃣ 一般使用者（已登入）
**可以做的事情**：
- 瀏覽完成轉檔的影片
- 使用搜尋和院區篩選
- **觀看影片**（含 EverCam 互動功能）
- **自動記錄觀看進度**
- 查看公告資訊

**無法做的事情**：
- ❌ 上傳或編輯影片
- ❌ 管理公告
- ❌ 訪問管理功能

### 2️⃣ 院區管理員 (Campus Admin)
**繼承一般使用者的所有權限，額外可以**：
- ✅ 上傳影片到所屬院區
- ✅ 編輯和刪除所屬院區的影片
- ✅ 管理所屬院區的公告
- ✅ **批次上傳所屬院區的公告**
- ✅ 查看和管理轉檔佇列
- ✅ 控制所屬院區的自動轉檔設定

**限制**：
- ❌ 只能管理自己院區的內容
- ❌ 無法查看其他院區的待處理影片
- ❌ 無法管理所有院區的設定

### 3️⃣ 系統管理員 (Manager)
**最高權限，可以**：
- ✅ 管理所有院區的影片
- ✅ 管理所有公告
- ✅ 查看和控制所有院區的轉檔佇列
- ✅ 統一管理所有院區的自動轉檔設定
- ✅ 新增、編輯、刪除任何內容
- ✅ 批次上傳公告

---

## 🔐 登入系統

### 登入方式

**使用現有帳號登入** - 無需額外註冊！

#### 登入步驟
1. 訪問平台首頁
2. 點擊右上角「登入」按鈕
3. **輸入您現有的帳號和密碼**
4. 系統自動驗證並登入

#### 第一次登入
首次使用時，系統會自動：
- ✅ 同步您的個人資料（姓名、院區歸屬）
- ✅ 分配適當的權限
- ✅ 建立使用者檔案

> 💡 **重要**：使用您在其他院內系統已有的帳號即可，不需要另外註冊新帳號。

#### 保持登入
- ✅ 勾選「保持登入狀態」
- ✅ 30 天內自動登入
- ✅ Token 自動續期機制
  - 每次訪問網站時，自動延長 30 天
  - 只要定期使用，永遠不會被登出
  - 連續 30 天未訪問才會過期

#### 登出
點擊右上角使用者名稱 → 選擇「登出」

---

## 🏠 首頁功能

首頁是使用者的主要入口，提供多種資訊瀏覽方式。

### 📢 輪播公告區

**位置**：首頁最上方（全螢幕輪播）

**功能**：
- 顯示重要公告訊息
- 支援圖片和文字內容
- 自動循環播放
- 點擊可跳轉至公告詳情頁

**顯示條件**：
公告必須同時滿足以下條件才會在輪播中顯示：
1. ✅ 標記為「輪播顯示」(`is_hero = 1`)
2. ✅ 在上架期間內：
   - 開始日期 (`hero_start_date`) ≤ 今天（或未設定）
   - 結束日期 (`hero_end_date`) > 今天（或未設定）

**上下架時間控制**：
- **開始日期**（選填）：公告開始在輪播中顯示的日期
- **結束日期**（選填）：公告從輪播中移除的日期
- **未設定日期**：表示不限制該時間點

**範例情境**：
```
情境 1：不限時輪播
  開始日期：未設定
  結束日期：未設定
  → 永久顯示（只要啟用且標記為輪播）

情境 2：限時活動公告
  開始日期：2026/01/20
  結束日期：2026/02/15
  → 只在 2026/01/20 ~ 2026/02/14 期間顯示

情境 3：預約上架
  開始日期：2026/02/01（未來日期）
  結束日期：未設定
  → 從 2026/02/01 開始顯示，無結束期限
```

**排序規則**：
- 按創建時間降序（最新的在前）

**管理員操作**：
1. 進入「公告管理」
2. 新增或編輯公告
3. 勾選「在首頁輪播顯示」
4. 設定「輪播開始日期」和「輪播結束日期」（選填）

---

### 📢 公告頁面

**訪問方式**：
- 點擊導覽列的「公告」按鈕
- 點擊輪播圖上的「查看公告」按鈕

**功能**：
- 顯示所有公告列表
- 支援分頁瀏覽
- 查看公告詳細內容

**公告顯示規則**：
- ✅ 顯示所有公告
- ❌ **已過期的演講不會顯示**
  - 如果公告設定了「演講日期」
  - 且演講日期 < 今天
  - 則該公告自動隱藏

**管理員額外功能**：
- 新增公告
- 編輯公告
- 刪除公告
- 批次上傳公告（管理員和院區管理員）

> 💡 **重點**：公告設定演講日期後，過期會自動隱藏，無需手動下架。

---

### 🎬 影片列表

**位置**：頁面主要內容區

#### 顯示資訊
每個影片卡片包含：
- 📸 縮圖
  - **已上傳**：顯示自訂縮圖
  - **未上傳**：系統自動從影片第 1 秒擷取畫面作為縮圖
- 🏥 院區標籤（顏色區分）
- 📺 影片標題
- 👤 講者姓名
- 🏢 講者服務單位
- 📅 演講日期
- 👁️ 觀看次數
- 📊 觀看進度（已登入使用者）

#### 院區篩選
**功能**：
- 「全部院區」：顯示所有已完成的影片
- 選擇特定院區：只顯示該院區的影片

**院區列表**（依資料庫設定）：
- 大林
- 花蓮
- 台中
- 台北
- 法人

#### 搜尋功能
- 🔍 搜尋欄位位於頁面上方
- 可搜尋：
  - 影片標題
  - 講者姓名
  - 講者服務單位
- 即時顯示搜尋結果
- 支援部分關鍵字匹配

#### 分頁
- 每頁顯示 12 部影片
- 頁面底部顯示分頁導航
- 保留搜尋和篩選條件

---

## 🎥 觀看影片

### 進入播放頁面
點擊任何影片卡片即可進入專屬播放頁面。

### 播放頁面功能

#### 1. 影片播放器
- 🎬 支援標準 MP4 影片
- 📱 支援 EverCam 互動式播放（包含章節、講義同步）
- ⏯️ 播放/暫停控制
- 🔊 音量調整
- 📺 全螢幕模式
- ⏱️ 進度拖曳

#### 2. 影片資訊
顯示欄位：
- 標題
- 講者姓名
- 服務單位
- 職務
- 演講日期
- 院區
- 影片總長度
- 上傳時間

#### 3. 自動記錄觀看進度
**機制**：
- ✅ 已登入使用者自動啟用
- ✅ 每 10 秒自動儲存一次進度
- ✅ 下次觀看時從上次位置繼續
- ✅ 進度條顯示於首頁影片卡片

**資料儲存**：
- 儲存在 `video_progress` 資料表
- 記錄：使用者ID、影片ID、觀看秒數、最後更新時間

#### 4. EverCam 特殊功能
對於 EverCam 格式的影片，額外提供：
- 📑 章節列表（快速跳轉）
- 📄 講義同步顯示
- 🖱️ 互動式簡報控制
- 🔍 講義內容搜尋

---

## 🎨 使用者介面特色

### 設計理念
- 🌈 現代化漸層設計
- 📱 完全響應式佈局（手機、平板、桌面）
- 🎭 品牌色系統一（#008491 主色）
- ✨ 流畢動畫效果
- 🌙 清晰的視覺層次

### 互動效果
- Hover 微抬升效果
- 平滑的過渡動畫
- 載入狀態提示
- 友善的錯誤訊息

---

## ❓ 常見問題（第一部分）

### Q1: 我的帳號角色是什麼？
**A**: 登入後，導航列會顯示您的權限功能。如果看到「上傳演講」或「影片管理」，表示您是管理員。

### Q2: 為什麼我無法看到某些影片？
**A**: 影片必須完成轉檔才會顯示在首頁。正在處理中的影片只有管理員能在「轉檔排程佇列」中看到。

### Q3: 觀看進度會在不同裝置同步嗎？
**A**: 是的！只要使用同一個帳號登入，進度會自動同步。

### Q4: 我可以下載影片嗎？
**A**: 目前平台僅提供線上觀看，不提供下載功能。

---

## 🔜 下一部分預告

第二部分將詳細說明：
- 📤 **影片上傳完整教學**
  - MP4 影片上傳
  - EverCam ZIP 上傳
  - 檔案格式和限制
  - 表單欄位說明
- 🔧 **影片編輯與管理**
- 🎬 **轉檔系統運作原理**
- 📝 **公告管理功能**

---

**準備好了嗎？請告訴我繼續第二部分！** 🚀



---

# 學術演講影片平台 - 使用者手冊（第二部分）

## 📤 影片上傳完整教學

### 權限要求
- ✅ 系統管理員：可上傳至任何院區
- ✅ 院區管理員：只能上傳至所屬院區

### 進入上傳頁面
1. 登入系統
2. 點擊導覽列的「上傳演講」按鈕

---

## 🎬 支援的檔案格式

系統支援**兩種**影片格式：

### 1️⃣ MP4 影片檔（標準格式）
- **格式**：`.mp4`
- **建議**：適合一般錄影檔案
- **處理**：自動轉檔為網頁優化格式

### 2️⃣ EverCam ZIP 檔（互動式簡報）
- **格式**：`.zip`
- **內容**：包含影片 + 簡報同步資料
- **優勢**：支援章節跳轉、講義同步顯示
- **限制**：
  - ZIP 必須包含 `config.js` 檔案
  - 必須是 EverCam 網頁匯出格式

---

## 📝 上傳表單欄位說明

### 必填欄位

#### 1. 演講標題
- **格式**：文字
- **範例**：「心臟醫學新趨勢研討會」
- **提示**：簡潔明確，方便搜尋

#### 2. 所屬院區
- **格式**：下拉選單
- **選項**：大林 / 花蓮 / 台中 / 台北 / 法人
- **限制**：
  - 系統管理員：可選擇任何院區
  - 院區管理員：只能選擇所屬院區（自動鎖定）

#### 3. 演講日期
- **格式**：日期選擇器
- **範例**：2026-01-27
- **用途**：影片排序、公告顯示

#### 4. 講者姓名
- **格式**：文字
- **範例**：「王大明」
- **說明**：系統自動管理講者資料

#### 5. 上傳影片檔案
- **格式**：`.mp4` 或 `.zip`
- **大小限制**：
  - ZIP 檔案：最大 512MB
  - 解壓後影片：視磁碟空間而定
  - MP4 檔案：最大 512MB

### 選填欄位

#### 6. 服務單位
- **格式**：文字
- **範例**：「台中慈濟醫院心臟科」
- **用途**：顯示於影片資訊

#### 7. 職務
- **格式**：文字
- **範例**：「醫師」、「護理師」
- **用途**：顯示於影片資訊

#### 8. 上傳縮圖
- **格式**：JPG / PNG 圖片
- **建議尺寸**：1280x720 像素
- **說明**：
  - 如果不上傳：系統自動從影片第 1 秒擷取畫面
  - 自動生成的縮圖檔名：`thumb_{影片ID}_auto.jpg`

---

## 📋 上傳步驟詳解

### 步驟 1：填寫表單
1. 輸入演講標題
2. 選擇所屬院區
3. 選擇演講日期
4. 輸入講者姓名
5. 輸入服務單位（選填）
6. 輸入職務（選填）

### 步驟 2：上傳檔案

#### 選項 A：上傳 MP4 影片
1. 點擊「上傳 mp4 或 evercam zip 檔」欄位
2. 選擇 `.mp4` 檔案
3. （選填）點擊「上傳縮圖」欄位，選擇縮圖圖片

#### 選項 B：上傳 EverCam ZIP
1. 從 EverCam 軟體執行「匯出網頁」功能
   - ✅ 勾選「包含影片」選項
   - ✅ 下載完整 ZIP 檔案
2. 點擊「上傳 mp4 或 evercam zip 檔」欄位
3. 選擇 `.zip` 檔案
4. （選填）上傳縮圖

### 步驟 3：開始上傳
1. 檢查所有欄位是否正確
2. 點擊「開始上傳」按鈕
3. 等待上傳完成
   - 顯示上傳進度條
   - 顯示上傳百分比
   - **請勿關閉頁面**

### 步驟 4：上傳完成
- ✅ 成功：顯示成功訊息，影片進入轉檔佇列
- ❌ 失敗：顯示錯誤原因（參考常見錯誤章節）

---

## ⚙️ 自動轉檔系統

### 轉檔機制

上傳成功後，影片**不會立即可觀看**，需經過轉檔處理：

#### 轉檔流程
1. **狀態：排隊中 (pending)**
   - 影片已上傳，等待 Worker 處理
   - 在轉檔佇列中排隊

2. **狀態：處理中 (processing)**
   - Worker 正在轉檔
   - 優先嘗試 GPU 加速 (NVIDIA NVENC)
   - GPU 失敗則改用 CPU 轉檔
   - 同時生成縮圖（如果未上傳）

3. **狀態：完成 (ready)**
   - 轉檔成功
   - 影片出現在首頁列表
   - 使用者可以觀看

4. **狀態：錯誤 (error)**
   - 轉檔失敗
   - 查看錯誤訊息並重新上傳

### 轉檔設定模式

每個院區可設定不同的轉檔模式：

#### 自動模式 (Auto)
- ✅ 上傳後**自動進入轉檔佇列**
- ✅ Worker 自動處理
- ✅ 適合：一般使用情境

#### 手動模式 (Manual)
- ⏸️ 上傳後**不會自動轉檔**
- 👤 管理員需手動觸發轉檔
- ✅ 適合：需要批次處理或排程轉檔

### 如何查看轉檔狀態

**管理員路徑**：
1. 點擊導覽列「轉檔排程管理」
2. 查看所有待處理影片列表
3. 顯示內容：
   - 影片標題
   - 上傳時間
   - 當前狀態
   - 錯誤訊息（如果有）

---

## 🔧 影片管理功能

### 進入影片管理頁面
1. 登入系統
2. 點擊導覽列「影片管理」按鈕

### 管理員可執行操作

#### 1️⃣ 查看影片列表
- 顯示所有影片（管理員）或所屬院區影片（院區管理員）
- 包含待處理、處理中、已完成、錯誤狀態的影片
- 顯示欄位：
  - 縮圖
  - 標題
  - 講者
  - 院區
  - 狀態
  - 上傳時間

#### 2️⃣ 編輯影片
**功能**：
- 修改演講標題
- 修改演講日期
- 修改講者資訊
- 更換縮圖
- **更換影片檔案**

**步驟**：
1. 在影片列表中找到要編輯的影片
2. 點擊「編輯」按鈕
3. 修改欄位
4. 點擊「儲存」

**更換影片檔案**：
- 選擇新的 MP4 或 ZIP 檔案
- 上傳後會重新進入轉檔佇列
- 舊影片檔案會被刪除

#### 3️⃣ 刪除影片
**功能**：永久刪除影片及相關資料

**步驟**：
1. 點擊影片的「刪除」按鈕
2. 確認刪除對話框
3. 系統自動刪除：
   - 影片檔案
   - 縮圖
   - 資料庫記錄
   - 觀看進度記錄

**警告**：刪除後無法復原！

---

## 📢 公告管理功能

### 進入公告管理頁面
1. 登入系統
2. 點擊導覽列「公告管理」按鈕

### 公告管理操作

#### 1️⃣ 新增公告
**步驟**：
1. 點擊「新增公告」按鈕
2. 填寫欄位：
   - **標題**（必填）
   - **院區**（必填）
   - **講者姓名**（選填）
   - **服務單位**（選填）
   - **演講日期**（選填）
   - **地點**（選填）
   - **詳細內容**（選填）
   - **圖片 URL**（選填）
   - **在首頁輪播顯示**（勾選框）
   - **輪播開始日期**（選填）
   - **輪播結束日期**（選填）
3. 點擊「儲存」

**輪播公告設定**：
- 勾選「在首頁輪播顯示」：公告會出現在首頁最上方輪播
- 設定開始/結束日期：控制輪播上下架時間
- 不設定日期：不限時輪播

**演講日期**：
- 設定演講日期後，過期公告會自動隱藏
- 如果 演講日期 < 今天 → 公告不顯示

#### 2️⃣ 編輯公告
**步驟**：
1. 在公告列表找到要編輯的公告
2. 點擊「編輯」按鈕
3. 修改欄位
4. 點擊「儲存」

#### 3️⃣ 刪除公告
**步驟**：
1. 點擊公告的「刪除」按鈕
2. 確認刪除

#### 4️⃣ 批次上傳公告
**權限**：系統管理員 + 院區管理員（限自己院區）

**步驟**：
1. 點擊「批次上傳公告」按鈕
2. 下載 Excel 範本檔案（`test_upload2.xlsx`）
3. 在 Excel 中填寫公告資料：
   - 標題
   - 內容
   - 院區
   - 講者姓名
   - 服務單位
   - 演講日期（格式：YYYY/MM/DD 或 YYYY-MM-DD）
4. 儲存為 `.xlsx` 檔案
5. 上傳 Excel 檔案
6. 系統自動批次新增公告

**注意事項**：
- 支援 `.xlsx` 和 `.csv` 格式
- 日期格式會自動轉換為標準格式
- 院區管理員只能上傳自己院區的公告

---

## ❌ 常見錯誤與解決

### 上傳錯誤

#### 錯誤 1：檔案過大
```
影片大小超過伺服器 php.ini 的限制 (upload_max_filesize)
```
**原因**：檔案超過 512MB  
**解決**：
- 壓縮影片品質
- 縮短影片長度
- 聯繫管理員調整伺服器設定

#### 錯誤 2：ZIP 無法開啟
```
無法開啟 ZIP 檔案。可能原因：
(1) 檔案損壞或不完整
(2) 不是有效的 ZIP 格式
(3) 檔案正在被其他程式使用
```
**解決**：
- 重新從 EverCam 匯出 ZIP
- 確認檔案下載完整
- 關閉其他可能使用該檔案的程式

#### 錯誤 3：找不到 config.js
```
ZIP 檔案中未找到 config.js, 這不是有效的 EverCam 網頁匯出檔
```
**解決**：
- 使用 EverCam 的「匯出網頁」功能
- 勾選「包含影片」選項
- 下載完整的 ZIP 檔案

#### 錯誤 4：解壓縮失敗（磁碟空間不足）
```
解壓縮失敗：磁碟空間不足。需要 1.5GB，但只剩 0.8GB
```
**解決**：
- 聯繫系統管理員清理磁碟空間

### 轉檔錯誤

#### 錯誤：轉檔失敗
**查看方式**：
1. 進入「轉檔排程管理」
2. 查看錯誤訊息

**常見原因**：
- 影片檔案損壞
- 影片格式不支援
- 伺服器資源不足

**解決**：
- 重新上傳影片
- 確認影片可正常播放
- 聯繫系統管理員

---

## 💡 上傳最佳實踐

### 影片檔案建議
- ✅ 使用 1080p 或 720p 解析度
- ✅ 建議位元率：2-5 Mbps
- ✅ 音訊格式：AAC
- ✅ 影片格式：H.264

### 縮圖建議
- ✅ 尺寸：1280x720 像素
- ✅ 格式：JPG（檔案較小）或 PNG
- ✅ 內容：選擇代表性畫面
- ✅ 避免：全黑畫面、過渡畫面

### EverCam ZIP 建議
- ✅ 確認勾選「包含影片」
- ✅ 下載完成後再上傳
- ✅ 不要解壓後重新壓縮

---

## 🔜 下一部分預告

第三部分將詳細說明：
- 🎬 轉檔排程管理詳解
- ⚙️ 自動壓縮模式設定
- 📊 系統設定與權限管理

---

**第二部分完成！** 🎉


---

# 學術演講影片平台 - 使用者手冊（第三部分）

## 🎬 轉檔排程管理

### 權限要求
- ✅ 系統管理員：管理所有院區的轉檔佇列和設定
- ✅ 院區管理員：管理所屬院區的轉檔佇列和設定

### 進入轉檔管理頁面
1. 登入系統
2. 點擊導覽列「轉檔排程管理」按鈕

---

## ⚙️ 自動壓縮模式設定

### 功能說明

每個院區可以獨立設定轉檔模式：

#### 🤖 自動模式 (Auto)
- **行為**：影片上傳後自動進入轉檔佇列
- **優勢**：
  - ✅ 無需手動操作
  - ✅ 影片自動排程處理
  - ✅ 自動通知轉檔主機
- **適用**：一般日常使用

#### 👤 手動模式 (Manual)
- **行為**：影片上傳後進入「等待 (waiting)」狀態
- **特點**：
  - 🔘 管理員需手動勾選要處理的影片
  - 🔘 點擊「開始轉檔」才會進入佇列
  - 🔘 適合批次處理或排程管理
- **適用**：需要控制轉檔時間或批次處理

### 設定方式

#### 系統管理員視圖
- 看到**所有院區的設定表格**
- 每個院區有獨立的開關按鈕

**操作步驟**：
1. 進入「轉檔排程管理」頁面
2. 在「自動壓縮模式設定」區塊中
3. 找到要調整的院區
4. 點擊該院區的開關按鈕
5. 狀態即時切換：
   - 🟢 已啟用 (Auto)
   - ⚪ 已停用 (Manual)

#### 院區管理員視圖
- 只看到**自己院區的設定**
- 右側有開關按鈕

**操作步驟**：
1. 進入「轉檔排程管理」頁面
2. 點擊右上角的開關按鈕
3. 狀態即時切換：
   - 🟢 已啟用 (Auto)
   - ⚪ 已停用 (Manual)

---

## 📋 待處理清單 (Waiting)

### 功能說明

當院區設定為**手動模式**時，上傳的影片會進入「待處理清單」，等待管理員手動啟動轉檔。

### 清單顯示內容

每個待處理影片顯示：
- ☑️ 勾選框（用於批次選擇）
- 🖼️ 縮圖
- 📝 影片標題
- ⏰ 上傳時間
- 🔴 狀態：Waiting

### 操作步驟

#### 1️⃣ 選擇要處理的影片

**單一選擇**：
- 直接勾選影片前的勾選框

**批次選擇**：
- 勾選表頭的「全選」勾選框
- 自動選取所有待處理影片

**取消選擇**：
- 再次點擊勾選框即可取消

#### 2️⃣ 開始轉檔

1. 確認已勾選要處理的影片
2. 點擊「開始轉檔所選影片」按鈕
3. 系統執行：
   - 更新選中影片狀態為 `pending`
   - 自動通知轉檔主機
   - 轉檔主機開始處理
4. 頁面顯示成功訊息：「已啟動 X 個影片的轉檔流程」

### 空清單狀態

當沒有待處理影片時：
- 顯示訊息：「目前沒有等待中的影片。」
- 表示：
  - 自動模式已啟用，無需手動操作
  - 或所有影片都已處理完成

---

## 📊 監控區域 (Pending / Processing)

### 功能說明

即時顯示**正在轉檔中**的影片列表，讓管理員掌握轉檔進度。

### 顯示內容

#### 狀態列表
- **Pending（排隊中）**：已排進佇列，等待 Worker 處理
- **Processing（處理中）**：Worker 正在轉檔

#### 顯示欄位
- 📝 影片 ID
- 🎬 影片標題
- 🔵 狀態標籤
- 💬 處理訊息
  - 成功：「正在轉檔中...」
  - 進度：可能顯示轉檔進度訊息

### 自動觸發機制

當監控區域中有 `pending` 狀態的影片時：
- 系統**自動觸發轉檔主機**
- 確保 Worker 持續處理佇列
- 無需手動干預

### 空列表狀態

當沒有正在處理的影片時：
- 顯示訊息：「目前沒有正在處理的影片。」
- 表示所有佇列都已處理完成

---

## 🔄 轉檔流程完整說明

### 狀態轉換流程

```
1. 上傳完成
   ↓
2. 判斷自動模式
   ├─ 是 (Auto)  → 狀態：**排隊中 (pending)** → Worker 開始處理
   └─ 否 (Manual) → 狀態：**待處理 (waiting)** → 等待管理員操作
                     ↓
              管理員勾選並點擊「開始轉檔」
                     ↓
                  狀態：**排隊中 (pending)**
                     ↓
3. Worker 處理
   - 狀態：**處理中 (processing)**
   - 訊息：「正在轉檔中...」
   ↓
4. 轉檔完成
   ├─ 成功 → 狀態：ready → 影片出現在首頁
   └─ 失敗 → 狀態：error → 顯示錯誤訊息
```

### Worker 處理邏輯

當影片進入 `pending` 狀態後：

#### 步驟 1：取得影片
- Worker 從資料庫取得第一個 `pending` 影片
- 更新狀態為 `processing`

#### 步驟 2：GPU 轉檔嘗試
- 使用 NVIDIA NVENC 硬體加速
- 編碼器：`h264_nvenc`
- 預設：`p4`（品質與速度平衡）
- 參數：`-rc vbr -cq 26`（可變位元率，品質 26）

#### 步驟 3：CPU 備援
- 如果 GPU 轉檔失敗（返回值 ≠ 0）
- 自動切換到 CPU 轉檔
- 編碼器：`libx264`
- 預設：`fast`
- 參數：`-crf 28`（恆定品質因子 28）

#### 步驟 4：生成縮圖
- 檢查是否需要生成縮圖：
  - 縮圖欄位為空
  - 或檔案不存在
  - 或檔名包含 `_auto`（上次自動生成）
- 從影片第 1 秒擷取畫面
- 儲存為 `thumb_{影片ID}_auto.jpg`
- 更新資料庫縮圖路徑

#### 步驟 5：完成
- 替換原始影片為轉檔後的影片
- 更新狀態為 `ready`
- 影片出現在首頁列表

#### 步驟 6：錯誤處理
- 轉檔失敗 → 狀態：`error`
- 檔案遺失 → 狀態：`error`
- 路徑錯誤 → 狀態：`error`

---

## 📈 轉檔效能與優化

### GPU 加速優勢

使用 NVIDIA GPU 轉檔的優勢：
- ⚡ 速度快：比 CPU 快 3-10 倍
- 💻 省資源：不佔用 CPU 資源
- 🔋 低功耗：GPU 專為影片編碼設計

### 轉檔參數說明

#### GPU 模式 (NVENC)
```bash
-c:v h264_nvenc      # 使用 NVIDIA 硬體編碼器
-preset p4           # 預設等級 4（品質與速度平衡）
-rc vbr              # 可變位元率模式
-cq 26               # 恆定品質 26（範圍 0-51，越小品質越高）
-c:a aac             # 音訊編碼器
-b:a 128k            # 音訊位元率
-movflags +faststart # 優化網頁播放（允許串流）
```

#### CPU 備援模式 (x264)
```bash
-c:v libx264         # 使用軟體編碼器
-crf 28              # 恆定品質因子 28
-preset fast         # 快速預設
-c:a aac             # 音訊編碼器
-b:a 128k            # 音訊位元率
-movflags +faststart # 優化網頁播放
```

### 建議檔案規格

為了最佳轉檔效果：
- 📹 **解析度**：1080p (1920x1080) 或 720p (1280x720)
- 🎞️ **影格率**：30fps 或 25fps
- 📊 **位元率**：2-5 Mbps（1080p）/ 1-3 Mbps（720p）
- 🔊 **音訊**：AAC 格式，128kbps

---

## 🛠️ 管理員最佳實踐

### 自動模式 vs 手動模式選擇

#### 適合自動模式的情境
- ✅ 日常一般使用
- ✅ 影片上傳頻率穩定
- ✅ 轉檔主機性能充足
- ✅ 希望簡化流程

#### 適合手動模式的情境
- ✅ 需要批次處理大量影片
- ✅ 希望控制轉檔時間（如夜間處理）
- ✅ 轉檔主機性能有限
- ✅ 需要優先處理特定影片

### 監控與維護

#### 定期檢查
- 📅 每天檢查「監控區域」
- 🔍 確認沒有長時間停留在 `processing` 的影片
- ⚠️ 檢查 `error` 狀態的影片並重新上傳

#### 錯誤處理
1. 在影片管理頁面找到 `error` 影片
2. 查看錯誤訊息
3. 根據錯誤原因處理：
   - 檔案損壞 → 重新上傳
   - 格式問題 → 轉檔為標準 MP4
   - 空間不足 → 聯繫管理員清理磁碟

#### 批次處理建議
1. 關閉自動模式（切換為手動）
2. 上傳所有影片
3. 在離峰時間（如晚上）
4. 一次性勾選所有影片並開始轉檔
5. 隔天檢查處理結果

---

## 💡 常見問題

### Q1: 為什麼影片一直停在 pending 狀態？
**A**: 可能原因：
- Worker 未啟動：檢查轉檔主機是否運行
- 佇列前面有其他影片：按順序處理，需等待
- 網路問題：Worker 主機與網站伺服器連線中斷

**解決**：
- 聯繫系統管理員檢查 Worker 狀態
- 等待前面的影片處理完成

### Q2: 可以看到轉檔進度百分比嗎？
**A**: 目前系統不顯示轉檔進度百分比，只顯示狀態（pending / processing / ready / error）。

### Q3: 轉檔失敗的影片會怎樣？
**A**: 
- 狀態變為 `error`
- 保留在資料庫中
- 不會出現在首頁
- 管理員需在「影片管理」頁面刪除或重新上傳

### Q4: 可以取消正在轉檔的影片嗎？
**A**: 目前無法直接取消。如果需要停止，必須：
1. 在轉檔主機上手動終止 Worker 程序
2. 回到網站刪除該影片
3. 重新啟動 Worker

### Q5: 院區設定改為手動模式後，已上傳的影片會怎樣？
**A**: 
- 已經在 `排隊中 (pending)` 或 `處理中 (processing)` 的影片不受影響
- 會繼續處理至完成
- 只有**新上傳**的影片才會進入 `待處理 (waiting)` 狀態

### Q6: 多個院區可以同時轉檔嗎？
**A**: 
- 是的，Worker 會按照上傳順序處理
- 不區分院區，統一排隊
- 先上傳的先處理

---

## 📊 系統設定總覽

### 資料庫表：system_settings

#### 結構
- `setting_key`：設定項目名稱（例如：`auto_compression`）
- `campus_id`：院區 ID
- `setting_value`：設定值（`0` = 關閉，`1` = 啟用）

#### 查詢優先級
當查詢某院區的設定時：
1. 先查詢該院區的專屬設定（`campus_id = 院區ID`）
2. 如果不存在，使用全域預設值（`campus_id = 0`）

#### 預設行為
如果資料庫中沒有任何設定：
- 系統預設為**關閉（手動模式）**
- 建議：首次使用時為所有院區設定自動模式

---

## 🎯 總結

### 轉檔管理核心要點

1. **靈活的模式設定**
   - 每個院區獨立設定
   - 自動/手動模式隨時切換

2. **簡易的手動觸發**
   - 勾選 → 點擊開始
   - 支援批次處理

3. **即時的監控功能**
   - 查看當前佇列
   - 自動觸發機制

4. **智慧的轉檔邏輯**
   - GPU 優先，CPU 備援
   - 自動生成縮圖
   - 錯誤自動重試（CPU）

---

**第三部分完成！** 🎉

這是使用者手冊系列的最後一部分。完整手冊涵蓋：
- **第一部分**：系統概述、角色權限、首頁功能、影片觀看
- **第二部分**：影片上傳、管理、公告管理
- **第三部分**：轉檔排程管理、自動壓縮設定、監控功能
