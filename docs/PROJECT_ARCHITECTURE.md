# å­¸ç¿’ç¶²å°ˆæ¡ˆæž¶æ§‹èªªæ˜Žæ–‡ä»¶ (Project Architecture)

æœ¬å°ˆæ¡ˆæ˜¯ä¸€å€‹é›†æˆäº† **Moodle æ•¸ä½å­¸ç¿’ç³»çµ±** çš„è‡ªè¨‚å…¥å£ç¶²å¹³å°ã€‚å®ƒä½œç‚ºä¸€å€‹å…¥å£é–€æˆ¶ (Portal)ï¼Œæä¾›äº†ç²¾ç·»çš„ä»‹é¢ã€çµ±ä¸€çš„èº«åˆ†é©—è­‰ (SSO) ä»¥åŠæ•´åˆå¼çš„å­¸ç¿’æ•¸æ“šå„€è¡¨æ¿ã€‚

---

## 1. ç³»çµ±æ•´é«”æž¶æ§‹ (System Overview)

æœ¬å°ˆæ¡ˆæŽ¡ç”¨ **PHP + MySQL + Moodle API** çš„æž¶æ§‹å¯¦ä½œï¼Œä¸»è¦åˆ†ç‚ºå…©å€‹å¤§åž‹å€å¡Šï¼š
1.  **å…¥å£ç¶²é–€æˆ¶ (The Portal)**ï¼šè² è²¬ä½¿ç”¨è€…å¸å¼•ã€è¨»å†Šã€ç™»å…¥åŠå€‹äººæ•¸æ“šå±•ç¤ºã€‚
2.  **å­¸ç¿’ç³»çµ± (Moodle)**ï¼šè² è²¬å¯¦éš›çš„èª²ç¨‹å…§å®¹ã€æ¸¬é©—åŠæˆç¸¾ç®¡ç†ã€‚

---

## 2. ç›®éŒ„çµæ§‹èˆ‡åŠŸèƒ½è©³è§£

### ðŸ“‚ æ ¹ç›®éŒ„ (Root)
*   `index.php`ï¼šå°ˆæ¡ˆé€²å…¥é»žã€‚è‡ªå‹•åˆ¤æ–·ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ï¼Œè·³è½‰è‡³ã€Œé¦–é ã€æˆ–ã€Œå„€è¡¨æ¿ã€ã€‚
*   `register.php` / `logout.php` / `change_password.php`ï¼šèº«åˆ†ç®¡ç†ç›¸é—œåŠŸèƒ½é é¢ã€‚
*   `get_sso_url.php`ï¼š**æ ¸å¿ƒçµ„ä»¶**ã€‚è² è²¬ç”¢ç”Ÿé€²å…¥ Moodle çš„åŠ å¯†å®‰å…¨é€šè¡Œè­‰ (SSO Token)ã€‚

### ðŸ“‚ `includes/` - æ ¸å¿ƒé‚è¼¯å±¤
é€™è£¡å­˜æ”¾ç³»çµ±çš„ã€Œå¤§è…¦ã€ï¼Œä¸åŒ…å«å±•ç¤ºä»‹é¢ï¼š
*   `config.php`ï¼šè³‡æ–™åº«é€£ç·šè³‡è¨Šã€Moodle API é‡‘é‘°ã€SSO å…±äº«é‡‘é‘°ç­‰å…¨åŸŸè¨­å®šã€‚
*   `auth.php`ï¼šç™»å…¥é©—è­‰ã€CSRF é˜²è­·ã€**ã€Œè¨˜ä½æˆ‘ã€(Auto Login)** åŠŸèƒ½çš„å¯¦ä½œã€‚
*   `moodle_api.php`ï¼šå°ˆé–€è™•ç†èˆ‡ Moodle Web Services é€šè¨Šçš„å‡½æ•¸å°è£ï¼Œç”¨ä¾†æŠ“å–èª²ç¨‹èˆ‡æˆç¸¾ã€‚
*   `functions.php`ï¼šé€šç”¨å·¥å…·å‡½æ•¸ã€‚

### ðŸ“‚ `templates/` - ä»‹é¢å±•ç¤ºå±¤
è² è²¬ç¶²é çš„ HTML éª¨æž¶ï¼š
*   `landing.php`ï¼šè¨ªå®¢çœ‹åˆ°çš„ã€Œå…¥å£é¦–é ã€ï¼ŒåŒ…å«å¸å¼•äººçš„è¦–è¦ºç‰¹æ•ˆ (Hero Section)ã€‚
*   `dashboard.php`ï¼šç™»å…¥å¾Œçš„ã€Œå€‹äººå„€è¡¨æ¿ã€ï¼Œå±•ç¤ºä½¿ç”¨è€…çš„å­¸ç¿’é€²åº¦ã€ä»£è¾¦äº‹é …ç­‰ã€‚
*   `async_loader.php`ï¼š**æ•ˆèƒ½å„ªåŒ–çµ„ä»¶**ã€‚è² è²¬éžåŒæ­¥åœ°å¾ž Moodle æŠ“å–æ•¸æ“šï¼Œé¿å…é é¢è¼‰å…¥æ™‚å¡é “ã€‚
*   `header.php` / `footer.php`ï¼šå°Žè¦½åˆ—ã€é å°¾èˆ‡å…¨ç«™å…±ç”¨çš„ JS/CSS è¼‰å…¥ã€‚

### ðŸ“‚ `api/` - å¾Œç«¯æŽ¥å£å±¤
*   `get_moodle_data.php`ï¼šæä¾›çµ¦å„€è¡¨æ¿å‰ç«¯å‘¼å«çš„ JSON æŽ¥å£ï¼Œè² è²¬ç²å–èª²ç¨‹èˆ‡æˆç¸¾æ•¸æ“šã€‚

### ðŸ“‚ `assets/` - éœæ…‹è³‡æºå±¤
*   `css/`ï¼šåŒ…å« `style.css` (å…¨å±€è£é£¾)ã€`landing.css` (é¦–é ç‰¹æ•ˆ) åŠ Moodle å°ˆç”¨ä¸»é¡Œæ¨£å¼ã€‚
*   `js/`ï¼š`main.js` (å…¥å£ç¶²äº’å‹•é‚è¼¯) èˆ‡ `moodle-custom-integration.js` (Moodle ç«¯çš„è‡ªè¨‚é¸å–®æ•´åˆ)ã€‚
*   `moodle-inject/`ï¼šå­˜æ”¾éœ€è¦ã€Œæ³¨å…¥ã€åˆ° Moodle ç³»çµ±è¨­å®šä¸­çš„æŒ‡ä»¤ç¨¿ï¼ˆå¦‚è‡ªè¨‚å°Žè¦½åˆ—ï¼‰ã€‚

### ðŸ“‚ `docs/` - èªªæ˜Žæ‰‹å†Š
*   `SSO_IMPLEMENTATION.md`ï¼šè©³è§£å–®ä¸€ç™»å…¥æŠ€è¡“ç´°ç¯€ã€‚
*   `AUTO_LOGIN_SSO.md`ï¼šè§£èªªè‡ªå‹•ç™»å…¥èˆ‡ Moodle æ¬Šé™åŒæ­¥çš„æ©Ÿåˆ¶ã€‚

---

## 3. æ ¸å¿ƒæŠ€è¡“æµç¨‹

### A. èº«åˆ†é©—è­‰éˆ (Chain of Trust)
1.  ä½¿ç”¨è€…åœ¨ **Portal** ç™»å…¥ã€‚
2.  Portal å¯«å…¥åŠ å¯† Cookie è‡³ç€è¦½å™¨ã€‚
3.  é€²å…¥ **Moodle** æ™‚ï¼ŒPortal ç”¢ç”Ÿä¸€å€‹çŸ­æ™‚æ•ˆçš„åŠ å¯†æ¬Šæ– (Token)ã€‚
4.  Moodle è§£å¯†å¾Œè‡ªå‹•ç‚ºä½¿ç”¨è€…å»ºç«‹å°æ‡‰èº«åˆ†ï¼Œå®Œæˆå…å¯†ç¢¼ç™»å…¥ã€‚

### B. æ•¸æ“šæ•´åˆ (Data Integration)
1.  å„€è¡¨æ¿åœ¨ç€è¦½å™¨ç«¯ç™¼èµ· AJAX è«‹æ±‚ã€‚
2.  `get_moodle_data.php` é€éŽå¾Œç«¯ API èˆ‡ Moodle è³‡æ–™åº«æˆ– Web Service æºé€šã€‚
3.  çµæžœä»¥ JSON å›žå‚³ä¸¦å‹•æ…‹æ¸²æŸ“åœ“é¤…åœ–æˆ–èª²ç¨‹å¡ç‰‡ï¼Œå¯¦ç¾ã€Œäººåœ¨ Portalï¼Œçœ‹å¾—åˆ° Moodle å…§å®¹ã€çš„æ•ˆæžœã€‚

---

## 4. æª”æ¡ˆé—œè¯åœ–

```mermaid
graph TD
    index.php --> templates/landing.php
    index.php --> templates/dashboard.php
    templates/dashboard.php --> api/get_moodle_data.php
    api/get_moodle_data.php --> includes/moodle_api.php
    includes/moodle_api.php --> Moodle_System((Moodle WebService))
    templates/header.php --> includes/auth.php
    get_sso_url.php --> includes/config.php
```

---
*æœ¬æ–‡ä»¶ç”±ç³»çµ±è‡ªå‹•ç”¢ç”Ÿï¼Œæœ€å¾Œæ›´æ–°æ–¼ 2025-12-19*
